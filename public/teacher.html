<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BYTEWEBNEST ¬∑ Teacher</title>

  <!-- CodeMirror core -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

  <!-- MODES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

  <!-- EDIT -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

  <!-- HINTS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/anyword-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/html-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/css-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/xml-hint.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #0f0a1a;
      color: #fff;
      font-family: system-ui;
    }
    header {
      padding: 14px;
      text-align: center;
      font-weight: 700;
      background: linear-gradient(90deg, #7b2ff7, #c09bff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 18px;
    }
    .wrap {
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 10px 0 12px;
      flex-wrap: wrap;
    }
    .pill {
      padding: 8px 10px;
      border: 1px solid rgba(123,47,247,.6);
      border-radius: 10px;
      background: rgba(26,16,42,.6);
      color: #e8e0ff;
      font-size: 13px;
    }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 8px;
      background: #ff4d4d;
      box-shadow: 0 0 10px rgba(255,77,77,.6);
      vertical-align: -1px;
    }
    .status-dot.ok {
      background: #2bd576;
      box-shadow: 0 0 10px rgba(43,213,118,.6);
    }
    .CodeMirror {
      height: 65vh;
      font-size: 15px;
      border-radius: 12px;
      border: 1px solid rgba(123,47,247,.35);
      overflow: hidden;
    }
    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      background: #7b2ff7;
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #9f6bff; }
  </style>
</head>

<body>
<header>BYTEWEBNEST ¬∑ Live Lesson ¬∑ Teacher</header>

<div class="wrap">
  <div class="toolbar">
    <div class="pill">
      <span id="dot" class="status-dot"></span>
      <span id="wsStatus">WS: connecting‚Ä¶</span>
    </div>
    <div class="pill">Lesson: <b id="lessonView">lesson-1</b></div>
    <div class="pill">–ê–≤—Ç–æ-–ø—É–±–ª–∏–∫–∞—Ü–∏—è: <b>ON</b> (‚âà 0.25s)</div>
    <div class="pill">–ö—É—Ä—Å–æ—Ä/–≤—ã–¥–µ–ª–µ–Ω–∏–µ: <b>ON</b> (‚âà 0.06s)</div>
  </div>

  <textarea id="editor">
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Demo</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Arial;
      padding: 24px;
    }
    h1 { color: #7b2ff7; }
    .card {
      border: 1px solid rgba(123,47,247,.5);
      border-radius: 12px;
      padding: 16px;
      background: rgba(26,16,42,.35);
    }
  </style>
</head>
<body>
  <h1>Hello BYTEWEBNEST</h1>
  <div class="card">
    <p>Live coding —Ä–∞–±–æ—Ç–∞–µ—Ç üöÄ</p>
  </div>
</body>
</html>
  </textarea>

  <button id="publish">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å (—Ñ–æ—Ä—Å)</button>
</div>

<script>
  // ====== CONFIG ======
  const WS_URL  = "wss://bwn-live-lesson.onrender.com/ws";
  const LESSON_ID = "lesson-1";
  const TEACHER_KEY = "bwn-live-2025"; // –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å BWN_KEY –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

  document.getElementById("lessonView").textContent = LESSON_ID;

  // ====== CodeMirror ======
  const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
    mode: "htmlmixed",
    theme: "material-darker",
    lineNumbers: true,
    autoCloseTags: true,
    autoCloseBrackets: true,
    indentUnit: 2,
    tabSize: 2,
    extraKeys: {
      "Ctrl-Space": "autocomplete",
      "Tab": (cm) => {
        if (cm.somethingSelected()) cm.indentSelection("add");
        else cm.replaceSelection("  ");
      }
    }
  });

  // –ê–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ (HTML/CSS/XML + –∑–∞–ø–∞—Å–Ω–æ–π anyword)
  function smartHint(cm) {
    try {
      const token = cm.getTokenAt(cm.getCursor());
      const mode = (token && token.state && token.state.localMode && token.state.localMode.mode && token.state.localMode.mode.name) || "";

      // –í–Ω—É—Ç—Ä–∏ <style> —á–∞—â–µ –≤—Å–µ–≥–æ –±—É–¥–µ—Ç css
      if (mode.includes("css")) {
        cm.showHint({ hint: CodeMirror.hint.css, completeSingle: false });
        return;
      }

      // HTML / XML
      cm.showHint({ hint: CodeMirror.hint.html, completeSingle: false });
    } catch {
      cm.showHint({ hint: CodeMirror.hint.anyword, completeSingle: false });
    }
  }

  editor.on("inputRead", (cm, change) => {
    const ch = (change.text && change.text[0]) ? change.text[0] : "";
    if (/[\w<\.\-:#]/.test(ch) && !cm.state.completionActive) {
      smartHint(cm);
    }
  });

  // ====== WS connect + reconnect ======
  const dot = document.getElementById("dot");
  const wsStatus = document.getElementById("wsStatus");

  let ws;
  let reconnectTimer = null;

  function setStatus(ok, text) {
    wsStatus.textContent = text;
    dot.classList.toggle("ok", !!ok);
  }

  function connect() {
    setStatus(false, "WS: connecting‚Ä¶");
    ws = new WebSocket(WS_URL);

    ws.onopen = () => setStatus(true, "WS: connected ‚úÖ");

    ws.onclose = () => {
      setStatus(false, "WS: disconnected‚Ä¶");
      if (!reconnectTimer) {
        reconnectTimer = setTimeout(() => {
          reconnectTimer = null;
          connect();
        }, 1200);
      }
    };

    ws.onerror = () => setStatus(false, "WS: error‚Ä¶");
  }

  connect();

  function sendSafe(payload) {
    if (!ws || ws.readyState !== WebSocket.OPEN) return false;
    ws.send(JSON.stringify(payload));
    return true;
  }

  // ====== LIVE SEND: CODE (debounce) ======
  let codeTimer = null;
  function sendCodeDebounced() {
    clearTimeout(codeTimer);
    codeTimer = setTimeout(() => {
      sendSafe({
        type: "code",
        lessonId: LESSON_ID,
        key: TEACHER_KEY,
        html: editor.getValue()
      });
    }, 250);
  }

  editor.on("change", () => {
    sendCodeDebounced();
  });

  // ====== LIVE SEND: CURSOR/SELECTION (throttle) ======
  let lastCursorSentAt = 0;
  function sendCursorThrottled() {
    const now = Date.now();
    if (now - lastCursorSentAt < 60) return;
    lastCursorSentAt = now;

    const sels = editor.listSelections();
    if (!sels || !sels[0]) return;

    // –±–µ—Ä—ë–º –ø–µ—Ä–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ (–æ–±—ã—á–Ω–æ —Ö–≤–∞—Ç–∞–µ—Ç)
    const from = sels[0].from();
    const to   = sels[0].to();

    sendSafe({
      type: "cursor",
      lessonId: LESSON_ID,
      key: TEACHER_KEY,
      from: { line: from.line, ch: from.ch },
      to:   { line: to.line,   ch: to.ch }
    });
  }

  editor.on("cursorActivity", () => {
    sendCursorThrottled();
  });

  // ====== FORCE BUTTON ======
  document.getElementById("publish").onclick = () => {
    // –∫–æ–¥
    sendSafe({
      type: "code",
      lessonId: LESSON_ID,
      key: TEACHER_KEY,
      html: editor.getValue()
    });

    // –∫—É—Ä—Å–æ—Ä/–≤—ã–¥–µ–ª–µ–Ω–∏–µ
    const sel = editor.listSelections()[0];
    const from = sel.from(), to = sel.to();
    sendSafe({
      type: "cursor",
      lessonId: LESSON_ID,
      key: TEACHER_KEY,
      from: { line: from.line, ch: from.ch },
      to:   { line: to.line,   ch: to.ch }
    });
  };

  // –ù–∞ —Å—Ç–∞—Ä—Ç–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  setTimeout(() => {
    document.getElementById("publish").click();
  }, 350);
</script>
</body>
</html>
